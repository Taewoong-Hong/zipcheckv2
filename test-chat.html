<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì±„íŒ… í…ŒìŠ¤íŠ¸</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 800px;
            margin: 50px auto;
            padding: 20px;
        }
        .container {
            background: #f5f5f5;
            border-radius: 10px;
            padding: 20px;
        }
        #log {
            background: #000;
            color: #00ff00;
            padding: 20px;
            border-radius: 5px;
            min-height: 300px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            overflow-y: auto;
            max-height: 500px;
        }
        button {
            background: #0066ff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #0052cc;
        }
        .error {
            color: #ff3333;
        }
        .success {
            color: #33ff33;
        }
        .info {
            color: #3399ff;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ZipCheck ì±„íŒ… API í…ŒìŠ¤íŠ¸</h1>

        <div>
            <button onclick="testHealthCheck()">1. Health Check í…ŒìŠ¤íŠ¸</button>
            <button onclick="testChatInit()">2. Chat Init í…ŒìŠ¤íŠ¸</button>
            <button onclick="testChatMessage()">3. Chat Message í…ŒìŠ¤íŠ¸</button>
            <button onclick="testFullFlow()">4. ì „ì²´ í”Œë¡œìš° í…ŒìŠ¤íŠ¸</button>
            <button onclick="clearLog()">ë¡œê·¸ ì´ˆê¸°í™”</button>
        </div>

        <h3>í…ŒìŠ¤íŠ¸ ë¡œê·¸:</h3>
        <div id="log"></div>
    </div>

    <script>
        let testSession = null;
        let testConversationId = null;

        function log(message, type = 'info') {
            const logDiv = document.getElementById('log');
            const timestamp = new Date().toLocaleTimeString();
            const className = type === 'error' ? 'error' : type === 'success' ? 'success' : 'info';
            logDiv.innerHTML += `<div class="${className}">[${timestamp}] ${message}</div>`;
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        function clearLog() {
            document.getElementById('log').innerHTML = '';
            log('ë¡œê·¸ê°€ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤.', 'info');
        }

        async function testHealthCheck() {
            log('=== Health Check í…ŒìŠ¤íŠ¸ ì‹œì‘ ===');
            try {
                const response = await fetch('http://localhost:3000/api/chat');
                const data = await response.json();

                if (response.ok) {
                    log(`âœ… Health Check ì„±ê³µ: ${JSON.stringify(data, null, 2)}`, 'success');
                } else {
                    log(`âŒ Health Check ì‹¤íŒ¨: ${JSON.stringify(data, null, 2)}`, 'error');
                }
            } catch (error) {
                log(`âŒ Health Check ì—ëŸ¬: ${error.message}`, 'error');
            }
        }

        async function testChatInit() {
            log('=== Chat Init í…ŒìŠ¤íŠ¸ ì‹œì‘ ===');

            // ë¨¼ì € ê°„ë‹¨í•œ ì„¸ì…˜ ì‹œë®¬ë ˆì´ì…˜
            testSession = {
                access_token: 'test_token_' + Date.now(),
                user: { id: 'test_user_' + Date.now() }
            };

            try {
                const response = await fetch('http://localhost:8000/chat/init', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${testSession.access_token}`
                    }
                });

                const data = await response.json();

                if (response.ok) {
                    testConversationId = data.conversation_id;
                    log(`âœ… Chat Init ì„±ê³µ: conversation_id = ${testConversationId}`, 'success');
                    log(`Response: ${JSON.stringify(data, null, 2)}`, 'info');
                } else {
                    log(`âŒ Chat Init ì‹¤íŒ¨ (${response.status}): ${JSON.stringify(data, null, 2)}`, 'error');
                }
            } catch (error) {
                log(`âŒ Chat Init ì—ëŸ¬: ${error.message}`, 'error');
            }
        }

        async function testChatMessage() {
            log('=== Chat Message í…ŒìŠ¤íŠ¸ ì‹œì‘ ===');

            if (!testSession) {
                log('âš ï¸ ì„¸ì…˜ì´ ì—†ìŠµë‹ˆë‹¤. ë¨¼ì € Chat Init í…ŒìŠ¤íŠ¸ë¥¼ ì‹¤í–‰í•˜ì„¸ìš”.', 'error');
                return;
            }

            const testMessage = 'ì „ì„¸ê³„ì•½ ì‹œ ì£¼ì˜ì‚¬í•­ì„ ì•Œë ¤ì£¼ì„¸ìš”';

            try {
                const response = await fetch('http://localhost:3000/api/chat', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        conversation_id: testConversationId,
                        content: testMessage,
                        session: testSession
                    })
                });

                if (response.ok) {
                    log(`âœ… Chat Message ì „ì†¡ ì„±ê³µ`, 'success');

                    // SSE ìŠ¤íŠ¸ë¦¬ë° ì‘ë‹µ ì²˜ë¦¬
                    const reader = response.body.getReader();
                    const decoder = new TextDecoder();
                    let buffer = '';

                    while (true) {
                        const { done, value } = await reader.read();
                        if (done) break;

                        buffer += decoder.decode(value, { stream: true });
                        const lines = buffer.split('\n');
                        buffer = lines.pop() || '';

                        for (const line of lines) {
                            if (line.startsWith('data: ')) {
                                const data = line.slice(6);
                                if (data) {
                                    try {
                                        const parsed = JSON.parse(data);
                                        if (parsed.content) {
                                            log(`ğŸ“ ì‘ë‹µ: ${parsed.content}`, 'info');
                                        }
                                        if (parsed.done) {
                                            log('âœ… ìŠ¤íŠ¸ë¦¬ë° ì™„ë£Œ', 'success');
                                        }
                                    } catch (e) {
                                        // JSON íŒŒì‹± ì˜¤ë¥˜ ë¬´ì‹œ
                                    }
                                }
                            }
                        }
                    }
                } else {
                    const data = await response.json();
                    log(`âŒ Chat Message ì‹¤íŒ¨ (${response.status}): ${JSON.stringify(data, null, 2)}`, 'error');
                }
            } catch (error) {
                log(`âŒ Chat Message ì—ëŸ¬: ${error.message}`, 'error');
            }
        }

        async function testFullFlow() {
            log('=== ì „ì²´ í”Œë¡œìš° í…ŒìŠ¤íŠ¸ ì‹œì‘ ===');
            log('1. Health Check...', 'info');
            await testHealthCheck();

            log('2. Chat Init...', 'info');
            await testChatInit();

            log('3. Chat Message...', 'info');
            await testChatMessage();

            log('=== ì „ì²´ í”Œë¡œìš° í…ŒìŠ¤íŠ¸ ì™„ë£Œ ===', 'success');
        }

        // í˜ì´ì§€ ë¡œë“œ ì‹œ ì´ˆê¸° ë©”ì‹œì§€
        window.onload = () => {
            log('ì±„íŒ… API í…ŒìŠ¤íŠ¸ í˜ì´ì§€ ì¤€ë¹„ ì™„ë£Œ', 'success');
            log('ë²„íŠ¼ì„ í´ë¦­í•˜ì—¬ í…ŒìŠ¤íŠ¸ë¥¼ ì‹œì‘í•˜ì„¸ìš”.', 'info');
        };
    </script>
</body>
</html>