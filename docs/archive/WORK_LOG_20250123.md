# 작업 일지 - 2025년 1월 23일

## 📋 완료된 작업

### 1. ✅ OAuth 로그인 수정 완료
- **문제**: 구글, 카카오 로그인 버튼이 작동하지 않음
- **원인**: `lib/supabase.ts`가 mock 클라이언트로 되어 있었음
- **해결**:
  - 실제 Supabase 클라이언트로 교체
  - OAuth redirect URL 추가: `window.location.href = data.url`
- **결과**: 구글, 카카오, 네이버 모두 정상 작동

### 2. ✅ 환경 변수 통합 및 정리
- **작업**: 중복된 `.env.local` 파일 정리
- **내용**:
  - 루트와 `apps/web/` 두 곳에 있던 파일 중 루트 파일로 통합
  - 10개 카테고리로 재정리 (이모지 포함)
  - 누락된 API 키 추가:
    - `ANTHROPIC_API_KEY` (Claude)
    - `GEMINI_API_KEY` (Google Gemini)
    - `JWT_SECRET` (Supabase JWT)

### 3. ✅ LLM 가드레일 시스템 구현
- **파일**: `services/ai/core/guardrails.py`
- **기능**:
  - 부동산 관련 질문만 허용
  - 코딩/프로그래밍 요청 차단
  - 일반 잡담 차단 (날씨, 맛집, 영화 등)
  - 번역/통역 요청 차단
- **알고리즘**:
  - 금지 키워드 체크 (최우선 차단)
  - 키워드 매칭 (70% 가중치)
  - 패턴 매칭 (30% 가중치)
  - 최종 점수 ≥ 0.7이면 허용

### 4. ✅ 정중한 분석가 말투 적용
- **파일**: `services/ai/core/prompts.py`
- **내용**:
  - "고객님", "~하십니다", "~드립니다" 등 존댓말 필수
  - 이모티콘 사용 금지
  - 반말 또는 친근한 말투 금지
  - 확정적 법률 판단 금지
  - 전문가 상담 권장 문구 포함
- **적용**: `services/ai/core/chains.py`에서 SystemMessage로 통합

### 5. ✅ RLS (Row Level Security) 정책 배포
- **파일**: `supabase/migrations/20250123_create_rls_policies.sql`
- **구현 내용**:
  - `is_admin()` 헬퍼 함수 생성 (JWT에서 app_metadata 확인)
  - `v2_contracts` 테이블 정책:
    - 사용자는 자신의 계약서만 조회/생성/수정/삭제
    - 관리자는 모든 계약서 접근 가능
  - `v2_documents` 테이블 정책:
    - 사용자는 자신의 문서만 조회/생성/삭제
    - 관리자는 모든 문서 접근 가능
  - `otp_codes` 테이블 정책:
    - 사용자는 자신의 OTP만 조회/생성/삭제
    - 관리자는 모든 OTP 접근 가능
  - 관리자 전용 뷰:
    - `admin_contracts_view`: 계약서 통계 포함
    - `admin_user_stats`: 사용자별 통계

### 6. ✅ 로그인 모달 엔터키 지원
- **파일**: `apps/web/components/auth/LoginModal.tsx`
- **변경 사항**:
  - 이메일 입력 필드에 `onKeyDown` 이벤트 추가
  - Enter 키 입력 시 "계속" 버튼과 동일한 동작
  - `handleEmailContinue` 함수 분리하여 재사용

### 7. ✅ 관리자 계정 설정
- **계정 정보**: `ghdxodnd@gmail.com` / `ghddnf123^^`
- **작업**:
  - `auth.users` 테이블에서 `raw_app_meta_data` 업데이트
  - `is_admin: true` 추가
- **SQL**:
```sql
UPDATE auth.users
SET raw_app_meta_data = jsonb_set(
  COALESCE(raw_app_meta_data, '{}'::jsonb),
  '{is_admin}',
  'true'::jsonb
)
WHERE email = 'ghdxodnd@gmail.com';
```

---

## 🚧 진행 중 작업 (내일 계속)

### 1. ❌ 이메일 존재 여부 확인 기능
- **문제**:
  - 이메일 입력 시 404 에러 발생
  - 존재하지 않는 `/auth/join` 페이지로 리다이렉트 시도
  - `auth.users` 테이블에 직접 접근 불가

- **해결 방안**:
  - Supabase RPC 함수 `check_email_exists()` 생성 필요
  - 함수가 `auth.users` 테이블 조회하여 이메일 존재 여부 반환

- **생성한 파일**:
  - `supabase/migrations/20250123_02_check_email_exists.sql`

- **SQL 내용**:
```sql
CREATE OR REPLACE FUNCTION public.check_email_exists(user_email TEXT)
RETURNS BOOLEAN AS $$
BEGIN
  RETURN EXISTS (
    SELECT 1
    FROM auth.users
    WHERE email = user_email
  );
END;
$$ LANGUAGE plpgsql SECURITY DEFINER;

GRANT EXECUTE ON FUNCTION public.check_email_exists(TEXT) TO anon, authenticated;
```

- **다음 단계**:
  1. Supabase Dashboard → SQL Editor에서 위 SQL 실행
  2. `LoginModal.tsx` 수정:
```typescript
// Supabase RPC 함수 호출
const { data: exists, error } = await supabase.rpc('check_email_exists', {
  user_email: savedEmail
});

if (exists) {
  // 기존 사용자 → 비밀번호 입력 단계로
  setEmailLoginStep("password");
} else {
  // 신규 사용자 → 회원가입 페이지로 이동
  window.location.href = "/auth/join?email=" + encodeURIComponent(savedEmail);
}
```

### 2. 🔧 개발 서버 재시작 필요
- **상태**: 파일 수정 중 Webpack 에러 발생
- **조치 필요**:
```bash
# 기존 서버 종료
taskkill //F //PID [해당 PID]

# 캐시 삭제 및 재시작
cd C:\dev\zipcheckv2\apps\web
rm -rf .next
npm run dev
```

---

## 📂 수정/생성된 주요 파일

### Frontend (Next.js)
- `apps/web/lib/supabase.ts` - Mock → 실제 클라이언트로 교체
- `apps/web/components/auth/LoginModal.tsx` - Enter 키 지원 추가
- `.env.local` - 환경 변수 통합 및 정리

### Backend (FastAPI)
- `services/ai/core/guardrails.py` - 가드레일 시스템 (신규 생성)
- `services/ai/core/prompts.py` - 시스템 프롬프트 정의 (신규 생성)
- `services/ai/core/chains.py` - 프롬프트 통합
- `services/ai/app.py` - 가드레일 적용

### Database (Supabase)
- `supabase/migrations/20250123_create_rls_policies.sql` - RLS 정책
- `supabase/migrations/20250123_01_set_admin_ghdxodnd.sql` - 관리자 설정 (실행 완료)
- `supabase/migrations/20250123_02_check_email_exists.sql` - 이메일 확인 함수 (실행 대기)

---

## 🔑 중요 정보

### 관리자 계정
- **이메일**: `ghdxodnd@gmail.com`
- **비밀번호**: `ghddnf123^^`
- **권한**: `app_metadata.is_admin = true`

### API 키 위치
- **파일**: `.env.local` (루트 디렉토리)
- **카테고리**: 10개 (Database, AI Backend, OAuth, Email, Payment, External APIs, Security, Admin, Dev Tools)

### 개발 서버
- **URL**: http://localhost:3000
- **상태**: 재시작 필요

---

## 📝 내일 할 일

1. **이메일 존재 여부 확인 기능 완성**
   - [ ] `check_email_exists` SQL 함수 배포
   - [ ] `LoginModal.tsx`에서 RPC 함수 호출 구현
   - [ ] 기존 사용자 → 비밀번호 입력
   - [ ] 신규 사용자 → 회원가입 페이지 (추후 구현)

2. **비밀번호 로그인 기능 구현**
   - [ ] 비밀번호 입력 후 `supabase.auth.signInWithPassword()` 호출
   - [ ] 로그인 성공 시 홈 페이지로 이동
   - [ ] 로그인 실패 시 에러 메시지 표시

3. **회원가입 페이지 생성** (옵션)
   - [ ] `apps/web/app/auth/join/page.tsx` 생성
   - [ ] 약관 동의 UI
   - [ ] 이메일 + 비밀번호 입력
   - [ ] Supabase Auth 회원가입 연동

4. **관리자 기능 테스트**
   - [ ] 관리자 로그인 확인
   - [ ] RLS 정책 동작 테스트
   - [ ] 관리자 뷰 접근 확인

---

## 🐛 알려진 이슈

1. **Webpack 빌드 에러**
   - 파일 수정 중 캐시 문제로 빌드 실패
   - `.next` 폴더 삭제 후 재시작 필요

2. **마이그레이션 버전 충돌**
   - 같은 날짜(`20250123`)로 여러 마이그레이션 생성
   - 시퀀스 번호 추가로 해결 (`20250123_01`, `20250123_02`)

3. **회원가입 페이지 없음**
   - 신규 사용자 입력 시 404 에러
   - 임시로 모든 사용자에게 비밀번호 입력창 표시 중

---

## 💡 참고 사항

### Supabase RLS 정책 확인
```sql
-- 현재 사용자 확인
SELECT auth.uid(), auth.jwt()->>'email';

-- 관리자 여부 확인
SELECT is_admin();

-- 접근 가능한 계약서 확인
SELECT * FROM v2_contracts;
```

### 가드레일 테스트
```python
from core.guardrails import check_question

# 부동산 관련 질문 (허용)
check_question("전세 계약서에서 특약사항이 뭔가요?")
# → {"allowed": True, "category": "contract_terms", "confidence": 0.85}

# 코딩 요청 (차단)
check_question("파이썬 코드 짜줘")
# → {"allowed": False, "category": "off_topic", "confidence": 1.0}

# 잡담 (차단)
check_question("오늘 날씨 어때?")
# → {"allowed": False, "category": "off_topic", "confidence": 0.95}
```

### 프롬프트 시스템 확인
```python
from core.prompts import SYSTEM_PROMPT, REJECTION_TEMPLATES

# 시스템 프롬프트
print(SYSTEM_PROMPT)

# 거절 템플릿
print(REJECTION_TEMPLATES["OFF_TOPIC"])
```

---

**작성 시간**: 2025-01-23 18:40
**다음 작업 예정일**: 2025-01-24
